C={canvas:{},mouse:{},sounds:{},canvasobj:{}};C.canvas.w=640;C.canvas.h=480;C.zombies=[];C.level=1;C.zombies_alive=0;C.zombie_count=10;C.projectiles=[];C.dead=[];C.crosshair_radius=15;C.images={};C.fps=100;C.total_fired=0;document.addEventListener("DOMContentLoaded",function(){C.init()},false);C.init=function(){if(!window.console||!console.firebug){(function(b,c){window.console={};while(c--){window.console[b[c]]=function(){}}})("log debug info warn error assert dir dirxml trace group groupEnd time timeEnd profile profileEnd count".split(" "),16)}console.log("init");var a=document.createElement("canvas");C.canvasobj=a;a.id="canvas";document.body.appendChild(a);a.style.cursor="url('img/1x1.gif'), default";a.width=C.canvas.w;a.height=C.canvas.h;C.ctx=a.getContext("2d");C.frame=0;C.player=new Player();C.player.bind_keys();C.create_zombies();a.addEventListener("mousemove",C.mousemove_handler,false);a.addEventListener("click",C.mouseclick_handler,false);C.mouse.currentx=C.canvas.w/2;C.mouse.currenty=C.canvas.h/2;C.load_resources();C.timer=setInterval(C.update,1000/C.fps)};C.load_resources=function(){C.images.player=[];C.images.player[1]=new Image();C.images.player[2]=new Image();C.images.player[1].src="img/kamil1.png";C.images.player[2].src="img/kamil2.png";C.images.player[0]=C.images.player[1];C.images.playerfire=[];C.images.playerfire[1]=new Image();C.images.playerfire[2]=new Image();C.images.playerfire[1].src="img/kamil1fire.png";C.images.playerfire[2].src="img/kamil2fire.png";C.images.terrain=new Image();C.images.terrain.src="img/terrain.png";C.images.deadzombie=new Image();C.images.deadzombie.src="img/deadzombie.png";C.images.blood=new Image();C.images.blood.src="img/blood.png";C.images.zombie=[];C.images.zombie[1]=new Image();C.images.zombie[1].src="img/zombi1.png";C.images.zombie[2]=new Image();C.images.zombie[2].src="img/zombi3.png";C.images.zombie[3]=new Image();C.images.zombie[3].src="img/zombi2.png";C.images.zombie[4]=new Image();C.images.zombie[4].src="img/zombi3.png";C.images.zombie[0]=C.images.zombie[1]};C.mouseclick_handler=function(a){C.player.fire();C.player.fire_anim=true;setTimeout(function(){C.player.fire_anim=false},100)};C.mousemove_handler=function(b){var d=C.canvasobj;var a=b.pageX-C.canvasobj.offsetLeft;var c=b.pageY-C.canvasobj.offsetTop;C.mouse.currentx=a;C.mouse.currenty=c;C.update_crosshair(a,c)};C.update_crosshair=function(a,b){C.crosshair_x=a;C.crosshair_y=b;C.crosshair_radius=Math.max(C.projectiles.length*10,15)};C.draw_crosshair=function(){var a=C.crosshair_x;var c=C.crosshair_y;if(a==undefined||a==null){a=C.canvas.w/2}if(c==undefined||c==null){c=C.canvas.h/2}var b=C.crosshair_radius;C.ctx.beginPath();C.ctx.arc(a,c,b,0,Math.PI*2,true);C.ctx.strokeStyle="rgb(255,0,0)";C.ctx.stroke();C.ctx.beginPath();C.ctx.fillStyle="rgba(31,32,37,0.6)";C.ctx.arc(a,c,b,0,Math.PI*2,true);C.ctx.fill()};C.levelcomplete=function(){setTimeout("clearInterval(C.timer)",2000);console.log("level completed!")};C.gameover=function(){clearInterval(C.timer);C.canvasobj.removeEventListener("mousemove",C.mousemove_handler,false);C.canvasobj.removeEventListener("click",C.mouseclick_handler,false);console.log("game over!")};C.create_zombies=function(){var b=C.zombie_count;for(var d=0;d<b;d++){var a=0,e=0,c=0;if(Math.random()<0.5){a=C.canvas.w}else{a=0}if(Math.random()<0.5){e=C.canvas.h}else{e=0}if(Math.random()<0.5){a=C.canvas.w*Math.random()}else{e=C.canvas.h*Math.random()}C.zombies.push(new Zombie(d,a,e))}C.zombies_alive=b};C.terrain=function(){var b=C.images.terrain.width;var m=C.images.terrain.height;var k=Math.ceil(C.canvas.w/b);var a=Math.ceil(C.canvas.h/m);for(var e=0;e<k;e++){for(var d=0;d<a;d++){C.ctx.drawImage(C.images.terrain,e*b,d*m)}}var h=100*(C.zombie_count-C.zombies_alive)/C.total_fired;var h=(h+"").substr(0,4)+"%";C.ctx.fillStyle="white";C.ctx.fillText("Hit ratio "+h,10,10);var n=C.images.deadzombie.width/2;var l=C.images.deadzombie.height/2;C.ctx.save();for(var e in C.dead){var g=C.dead[e];C.ctx.save();C.ctx.translate(g.x,g.y);var f=1.5*Math.PI;if(g.direction>0){f=Math.PI*0.5}C.ctx.rotate((g.direction+f));C.ctx.drawImage(C.images.blood,0,0);C.ctx.drawImage(C.images.deadzombie,0-n,0-l);C.ctx.restore()}C.ctx.restore()};C.update=function(){C.frame++;for(var a in C.zombies){var c=C.zombies[a];c.move()}for(var a in C.projectiles){var b=C.projectiles[a];b.move()}C.player.move();C.draw()};C.draw=function(){C.terrain();for(var a in C.zombies){var c=C.zombies[a];c.draw()}for(var a in C.projectiles){var b=C.projectiles[a];b.draw()}C.draw_crosshair();C.player.draw()};Zombie=function(c,a,b){this.id=c;this.x=a;this.y=b;this.radius=10;this.health=100;this.vel=0.2;this.direction=Math.atan2(C.player.x-this.x,C.player.y-this.y)};Zombie.prototype.move=function(){var b=Math.random();if(b<0.4){return}this.direction=Math.atan2(C.player.x-this.x,C.player.y-this.y);if(b<0.6){}var a=Math.ceil(C.frame/(C.fps/2));C.images.zombie[0]=C.images.zombie[1+(a%C.images.zombie.length-1)];this.y+=Math.cos(this.direction)*this.vel;this.x+=Math.sin(this.direction)*this.vel;if(this.detect_player_collision()){C.gameover()}};Zombie.prototype.detect_player_collision=function(){var b=this.x-C.player.x;var c=this.y-C.player.y;var a=Math.sqrt(b*b+c*c);return a<this.radius+C.player.radius};Zombie.prototype.draw=function(){var a=C.images.zombie[0].width/2;var b=C.images.zombie[0].height/2;C.ctx.save();C.ctx.translate(this.x,this.y);C.ctx.rotate(-1*(Math.PI+this.direction));C.ctx.drawImage(C.images.zombie[0],0-a,0-b);C.ctx.restore()};Zombie.prototype.hit=function(){this.die()};Zombie.prototype.die=function(){for(var a in C.zombies){var b=C.zombies[a];if(b.id==this.id){C.zombies.splice(a,1);C.zombies_alive--;if(C.zombies_alive==0){C.levelcomplete()}C.dead.push(this);console.log("dead zombie direction: %f",this.direction*180/Math.PI);return}}};Player=function(){this.x=C.canvas.w/2;this.y=C.canvas.h/2;this.radius=10;this.direction=0;this.maxspeed=0.5;this.vel=0;this.vel2=0;this.bullets=10;this.fire_anim=false;this.sprite_idx=1};Player.prototype.bind_keys=function(){document.onkeydown=function(a){var b=(a===null?window.event.keyCode:a.keyCode);switch(b){case 87:C.player.vel=-C.player.maxspeed;break;case 83:C.player.vel=C.player.maxspeed;break;case 65:C.player.vel2=-C.player.maxspeed;break;case 68:C.player.vel2=C.player.maxspeed;break}};document.onkeyup=function(a){var b=(a===null?window.event.keyCode:a.keyCode);switch(b){case 83:case 87:C.player.vel=0;break;case 65:case 68:C.player.vel2=0;C.player.angle=0;break}}};Player.prototype.move=function(){this.direction=Math.atan2(C.mouse.currentx-this.x,C.mouse.currenty-this.y);this.x+=this.vel2;this.y+=this.vel;if(this.vel2!=0||this.vel!=0){var b=Math.ceil(4*C.frame/C.fps);var a=C.images.player.length-1;this.sprite_idx=1+(b%a);C.images.player[0]=C.images.player[this.sprite_idx]}if(this.fire_anim){var b=Math.ceil(4*C.frame/C.fps);var a=C.images.playerfire.length-1;C.images.player[0]=C.images.playerfire[1+(b%a)]}else{C.images.player[0]=C.images.player[this.sprite_idx]}};Player.prototype.draw=function(){var a=C.images.player[0].width/2;var b=C.images.player[0].height/2;C.ctx.save();C.ctx.translate(this.x,this.y);C.ctx.rotate(-1*(Math.PI+this.direction));C.ctx.drawImage(C.images.player[0],0-a,0-b);C.ctx.restore()};Player.prototype.fire=function(){if(this.bullets==0){this.reload();return}C.total_fired++;this.bullets--;C.projectiles.push(new Bullet(this.x,this.y))};Player.prototype.reload=function(){console.log("reloading");this.bullets=10};Bullet=function(a,f){this.id=new Date().getTime();this.x=a;this.y=f;var e=Math.random()*2*Math.PI;var d=Math.random()*C.crosshair_radius;var c=C.crosshair_x+d*Math.cos(e);var b=C.crosshair_y+d*Math.sin(e);this.direction=Math.atan2(c-this.x,b-this.y);this.vel=0.5;this.radius=1;this.life=1;this.tx=this.x;this.ty=this.y};Bullet.prototype.detect_collision=function(){for(var a in C.zombies){var e=C.zombies[a];var c=this.x-e.x;var f=this.y-e.y;var b=Math.sqrt(c*c+f*f);if(b<this.radius+e.radius){console.log("bullet %d collided with zombie %d",this.id,e.id);return{id:e.id,pos:a}}}return false};Bullet.prototype.move=function(){var b=Math.sin(this.direction)*this.vel;var a=Math.cos(this.direction)*this.vel;this.x=this.x+b*this.life;this.y=this.y+a*this.life;this.life+=this.vel;var c=this.detect_collision();if(c){this.evict();C.zombies[c.pos].hit()}if(this.x<0||this.x>C.canvas.w){this.evict()}if(this.y<0||this.y>C.canvas.h){this.evict()}};Bullet.prototype.evict=function(){for(var a in C.projectiles){var b=C.projectiles[a];if(b.id==this.id){C.projectiles.splice(a,1);break}}};Bullet.prototype.draw=function(){var a=15;C.ctx.beginPath();C.ctx.arc(this.x,this.y,this.radius,0,Math.PI*2,true);C.ctx.fillStyle="white";C.ctx.fill();C.ctx.beginPath();var b=C.ctx.createLinearGradient(this.x,this.y,this.tx,this.ty);b.addColorStop(0,"rgba(255,255,255,1)");b.addColorStop(1,"rgba(0,0,0,0)");C.ctx.strokeStyle=b;C.ctx.moveTo(this.x,this.y);C.ctx.lineTo(this.tx,this.ty);C.ctx.stroke()};